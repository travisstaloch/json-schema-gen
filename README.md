# json-schema-gen

Generate zig code from arbitrary json data which can parse it.

Depends on python3 - tested with Python 3.10.12

## Motivation

When you need to parse arbitrary json in zig, you usually pass `std.json.Value` to one of the parse() methods.  This is convenient but is generally slower and allocates more memory than passing a concrete type.

Also, `std.json.Value` can be a little akward at times.  Here is how it looks to access data from the [github api](https://api.github.com/search/repositories?q=topic:zig-package&page=1&per_page=100)

with std.json.Value:

```zig
const url = parsed.value.object.get("items").?
    .array.items[0].object.get("commits_url").?.string;
```
with generated schema:
```zig
const url = parsed.value.items[0].commits_url;
```

This library was developed after struggling with code generated by <https://aerth.github.io/json-to-zig/>.  Hopefully std.json gets diagnostics soon cause it can be difficult to tell which fields were causing parse errors.

## Generate a schema

clone or download this project and run

```console
$ zig build json -- ../simdjzon/test/twitter.json
parsing .../simdjzon/test/twitter.json
schema  .../json-schema-gen/.zig-cache/o/d67a665fa470199a9c89b3acff0acd58/stdout
success!
```

Running with --verbose shows how the build system uses json-to-zig-schema.py to generate a zig schema file in the cache.  The schema file is then used by [src/main.zig](src/main.zig) to parse the json file.  The json path and generated schema paths are shown along with a 'success!' message or an error trace if parsing fails.

```console
$ zig build json --verbose -- ../simdjzon/test/twitter.json
python3 src/json-to-zig-schema.py ../simdjzon/test/twitter.json
# ... omitted
.../json-schema-gen/.zig-cache/o/0ef81ace90ad368f1e00b92e39512af1/parse-json-with-gen-schema ../simdjzon/test/twitter.json

parsing .../simdjzon/test/twitter.json
schema  .../json-schema-gen/.zig-cache/o/d67a665fa470199a9c89b3acff0acd58/stdout
success!
```

The [python script](src/json-to-zig-schema.py) has a couple options

```console
$ python3 src/json-to-zig-schema.py -h

USAGE: $ src/json-to-zig-schema.py <json-file-path> <?options>
  options:
    --debug-json  - add a jsonParse() method to each object which prints field names.
    --dump-schema - print schema json instead of generating zig code.

```

## Using generated schema

[src/main.zig](src/main.zig) shows how to pass the generated schema file to a std.json.parse() method.  If you want to do the same, you can

1. run `zig build json /path/to/my.json` and copy the output schema path next to your zig file.  lets call it `json-schema.zig`
2. add this line to your zig file: `const generated = @import("json-schema.zig");`
3. parse all the jsons!

## Troubleshooting parse errors

If your json file won't parse, you can use the --debug-json option to generate zig code which prints field names as they are parsed.  Note: you may have to clear your .zig-cache for this to work.

```console
$ zig build json -- ../simdjzon/test/twitter.json --debug-json
# ... many lines omitted
query
refresh_url
count
since_id
since_id_str
success!
```
